<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8" />
  <title>Shop Manager - Bathroom Image Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Integrated friend's upload styles with your overall theme */
    body {
      background: linear-gradient(135deg, #f5f0ff 0%, #faf6ff 100%);
      margin: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px 60px; /* extra bottom padding for button */
      user-select: none;
      position: relative;
    }

    /* Back button fixed top-left (your original) */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #8a2be2 0%, #9370db 100%);
      color: white;
      font-weight: 700;
      font-size: 1rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(138, 43, 226, 0.3);
      transition: background-color 0.3s ease, transform 0.2s ease;
      user-select: none;
      outline: none;
      z-index: 1000;
      text-align: center;
      white-space: nowrap;
    }
    .back-button:hover {
      background-color: #6a0dad;
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(106, 13, 173, 0.5);
    }
    .back-button:active {
      transform: translateY(0);
    }

    h1 {
      color: #6a0dad;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 40px;
      letter-spacing: 1.5px;
      text-align: center;
      max-width: 900px;
      width: 100%;
    }

    /* Adapted to flex for friend's tile-sections (your grid becomes upload-container) */
    .upload-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      max-width: 800px;
      width: 100%;
    }

    /* Friend's tile-section styles (integrated) */
    .tile-section {
      background: white;
      border: 2px dashed #ddd; /* Dashed for drop zone feel */
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      width: 180px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Your shadow theme */
      transition: border-color 0.3s, box-shadow 0.3s; /* Smooth feedback */
      position: relative;
      cursor: pointer; /* Pointer for drag/drop */
    }
    .tile-section:hover {
      border-color: #8a2be2;
      box-shadow: 0 4px 12px rgba(138,43,226,0.2);
    }
    .tile-section.has-image {
      border-color: #4caf50; /* Green border when image uploaded */
      box-shadow: 0 4px 12px rgba(76,175,80,0.3);
    }
    .tile-section h3 { 
      margin: 0 0 10px; 
      color: #6a0dad; 
      font-size: 1.1rem; 
    }
    .tile-section input[type="file"] {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }
    .preview {
      width: 150px; /* Larger for better visibility */
      height: 150px;
      border: 2px solid #ccc;
      border-radius: 8px;
      margin: 10px auto;
      object-fit: cover; /* Fits image nicely without distortion */
      display: none; /* Hidden until upload */
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .preview-container {
      margin: 10px 0;
      min-height: 150px; /* Ensures space for preview */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clear-btn {
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 5px;
      display: none; /* Shown only when image uploaded */
      font-size: 0.8rem;
    }
    .clear-btn:hover { background: #d32f2f; }
    .error { 
      color: red; 
      font-size: 0.9rem; 
      display: none; 
      margin-top: 5px;
    }
    .drag-text {
      font-size: 0.9rem;
      color: #888;
      margin: 10px 0;
      display: block;
    }

    /* Generate 3D button (your original, with friend's hover) */
    #generate3dBtn {
      margin-top: 40px;
      padding: 16px 36px;
      background: linear-gradient(135deg, #8a2be2 0%, #9370db 100%);
      color: white;
      font-weight: 700;
      font-size: 1.3rem;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 12px 40px rgba(138, 43, 226, 0.4);
      transition: background-color 0.3s ease, transform 0.2s ease;
      user-select: none;
      outline: none;
      max-width: 300px;
      width: 100%;
      text-align: center;
    }
    #generate3dBtn:hover {
      background-color: #6a0dad;
      transform: translateY(-3px);
      box-shadow: 0 18px 50px rgba(106, 13, 173, 0.6);
    }
    #generate3dBtn:active {
      transform: translateY(0);
    }

    /* Validation message (your original) */
    #validationMsg {
      color: #ff6b6b;
      font-weight: 600;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    @media (max-width: 600px) {
      .upload-container { flex-direction: column; align-items: center; }
      .tile-section { width: 90%; }
      .preview { width: 120px; height: 120px; } /* Smaller on mobile */
    }
  </style>
</head>
<body>

  <button class="back-button" onclick="history.back()">Back</button>

  <h1>Upload Bathroom Tile</h1>

  <!-- Friend's upload-container with 4 tile-sections (L, HL, D, F) -->
  <div class="upload-container">
    <!-- L Tile -->
    <div class="tile-section" data-category="L">
      <h3>L Tile</h3>
      <input type="file" id="fileL" accept="image/*">
      <div class="preview-container">
        <img id="previewL" class="preview" alt="L Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearL">Clear</button>
      <p class="error" id="errorL">Please upload an image.</p>
    </div>
    
    <!-- HL Tile -->
    <div class="tile-section" data-category="HL">
      <h3>HL Tile</h3>
      <input type="file" id="fileHL" accept="image/*">
      <div class="preview-container">
        <img id="previewHL" class="preview" alt="HL Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearHL">Clear</button>
      <p class="error" id="errorHL">Please upload an image.</p>
    </div>
    
    <!-- D Tile -->
    <div class="tile-section" data-category="D">
      <h3>D Tile</h3>
      <input type="file" id="fileD" accept="image/*">
      <div class="preview-container">
        <img id="previewD" class="preview" alt="D Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearD">Clear</button>
      <p class="error" id="errorD">Please upload an image.</p>
    </div>
    
    <!-- F Tile -->
    <div class="tile-section" data-category="F">
      <h3>F Tile</h3>
      <input type="file" id="fileF" accept="image/*">
      <div class="preview-container">
        <img id="previewF" class="preview" alt="F Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearF">Clear</button>
      <p class="error" id="errorF">Please upload an image.</p>
    </div>
  </div>

  <div id="validationMsg">Please upload images for all categories (L, HL, D, F) before generating 3D.</div>

  <button id="generate3dBtn">Generate 3D</button>

  <script>
    // Object to store base64 images (your original, but integrated with friend's logic)
    const uploadedImages = {
      L: null,
      HL: null,
      D: null,
      F: null
    };

    // DOM Elements (friend's style)
    const fileL = document.getElementById('fileL');
    const previewL = document.getElementById('previewL');
    const errorL = document.getElementById('errorL');
    const clearL = document.getElementById('clearL');
    const fileHL = document.getElementById('fileHL');
    const previewHL = document.getElementById('previewHL');
    const errorHL = document.getElementById('errorHL');
    const clearHL = document.getElementById('clearHL');
    const fileD = document.getElementById('fileD');
    const previewD = document.getElementById('previewD');
    const errorD = document.getElementById('errorD');
    const clearD = document.getElementById('clearD');
    const fileF = document.getElementById('fileF');
    const previewF = document.getElementById('previewF');
    const errorF = document.getElementById('errorF');
    const clearF = document.getElementById('clearF');
    const generate3dBtn = document.getElementById('generate3dBtn');
    const validationMsg = document.getElementById('validationMsg');

    // Friend's handleFileUpload and processFile (integrated for drag/drop and processing)
    function handleFileUpload(input, preview, error, clearBtn, container, dragText) {
      input.addEventListener('change', (e) => {
        processFile(e.target.files[0], preview, error, clearBtn, container, dragText);
      });

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        container.style.borderColor = '#8a2be2';
      });
      container.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!container.classList.contains('has-image')) container.style.borderColor = '#ddd';
      });
      container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.style.borderColor = '#ddd';
        const file = e.dataTransfer.files[0];
        if (file) {
          input.files = e.dataTransfer.files;
          processFile(file, preview, error, clearBtn, container, dragText);
        }
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        preview.src = '';
        preview.style.display = 'none';
        dragText.style.display = 'block';
        error.style.display = 'none';
        container.classList.remove('has-image');
        clearBtn.style.display = 'none';
        // Clear from uploadedImages
        const category = container.getAttribute('data-category');
        uploadedImages[category] = null;
        console.log(`${category} cleared from storage.`); // Debug
      });
    }

    function processFile(file, preview, error, clearBtn, container, dragText) {
      if (file) {
        if (file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const dataUrl = e.target.result;
            preview.src = dataUrl;
            preview.style.display = 'block';
            dragText.style.display = 'none';
            error.style.display = 'none';
            container.classList.add('has-image');
            clearBtn.style.display = 'inline-block';
            // Store base64 in uploadedImages (by category)
            const category = container.getAttribute('data-category');
            uploadedImages[category] = dataUrl;
            console.log(`${category} image uploaded and stored:`, dataUrl.substring(0, 50) + '...'); // Debug
          };
          reader.readAsDataURL(file);
        } else {
          error.textContent = 'Invalid image (must be JPG/PNG, <=5MB).';
          error.style.display = 'block';
          preview.style.display = 'none';
          dragText.style.display = 'block';
          container.classList.remove('has-image');
          clearBtn.style.display = 'none';
          // Don't store invalid
          const category = container.getAttribute('data-category');
          uploadedImages[category] = null;
        }
      }
    }

    // Attach handlers (friend's sections array)
    const sections = [
      { input: fileL, preview: previewL, error: errorL, clear: clearL, container: document.querySelector('[data-category="L"]'), dragText: document.querySelector('[data-category="L"] .drag-text') },
      { input: fileHL, preview: previewHL, error: errorHL, clear: clearHL, container: document.querySelector('[data-category="HL"]'), dragText: document.querySelector('[data-category="HL"] .drag-text') },
      { input: fileD, preview: previewD, error: errorD, clear: clearD, container: document.querySelector('[data-category="D"]'), dragText: document.querySelector('[data-category="D"] .drag-text') },
      { input: fileF, preview: previewF, error: errorF, clear: clearF, container: document.querySelector('[data-category="F"]'), dragText: document.querySelector('[data-category="F"] .drag-text') }
    ];

    sections.forEach(({ input, preview, error, clear, container, dragText }) => {
      handleFileUpload(input, preview, error, clear, container, dragText);
    });

        // Generate 3D button (your original flow, integrated with friend's validation & async base64)
    generate3dBtn.addEventListener('click', async () => {
      let valid = true;
      const checks = [
        { key: 'L', file: fileL, error: errorL },
        { key: 'HL', file: fileHL, error: errorHL },
        { key: 'D', file: fileD, error: errorD },
        { key: 'F', file: fileF, error: errorF }
      ];

      // Validate all uploads (friend's style: check files[0], show per-category errors)
      checks.forEach(({ key, file, error }) => {
        if (!file.files[0]) {
          error.textContent = `Please upload ${key} image.`;
          error.style.display = 'block';
          valid = false;
        } else {
          error.style.display = 'none'; // Hide if valid
        }
      });

      if (!valid) {
        validationMsg.textContent = 'Please upload all four images before generating 3D.';
        validationMsg.style.display = 'block';
        console.log('Validation failed: Not all images uploaded.'); // Debug
        return;
      }

      // All valid: Collect base64 with Promises (friend's async style)
      const images = {};
      const promises = [];
      checks.forEach(({ key, file }) => {
        const promise = new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            images[key] = e.target.result; // Store base64 DataURL
            // Also update uploadedImages for consistency
            uploadedImages[key] = e.target.result;
            resolve();
          };
          reader.readAsDataURL(file.files[0]);
        });
        promises.push(promise);
      });

      try {
        await Promise.all(promises);
        localStorage.setItem('bathroomTextures', JSON.stringify(images));
        console.log('All textures stored in localStorage:', Object.keys(images)); // Debug (keys: L, HL, D, F)
        console.log('Verify storage:', localStorage.getItem('bathroomTextures').substring(0, 100) + '...'); // Debug first 100 chars

        // Success: Show message and navigate (your flow)
        validationMsg.textContent = 'Images processed successfully! Redirecting to 3D view...';
        validationMsg.style.color = '#4caf50'; // Green for success
        validationMsg.style.display = 'block';
        console.log('Redirecting to bathroom3dview.html'); // Debug

        // Delay for UX (your original 1000ms)
        setTimeout(() => {
          window.location.href = 'bathroom3dview.html';
        }, 1000);
      } catch (err) {
        console.error('Base64 conversion error:', err);
        validationMsg.textContent = 'Error processing images. Please try again.';
        validationMsg.style.color = '#ff6b6b';
        validationMsg.style.display = 'block';
      }
    });

    // Optional: Auto-hide validation after 5s if error (your original UX)
    const observer = new MutationObserver(() => {
      if (validationMsg.style.display === 'block' && validationMsg.style.color === '#ff6b6b') {
        setTimeout(() => {
          if (validationMsg.style.display === 'block') {
            validationMsg.style.display = 'none';
          }
        }, 5000);
      }
    });
    observer.observe(validationMsg, { attributes: true, attributeFilter: ['style'] });

    // Final script load confirmation (friend's style)
    console.log('bathroom.html upload script loaded completely. Ready for image uploads and 3D generation!');
  </script>

</body>
</html>
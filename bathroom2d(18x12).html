<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bathroom Tile Uploader & Preview Generator</title>
  
  <!-- CDNs for PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- QR Code Scanner Library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <style>
      .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(138, 43, 226, 0.1);
            border: 2px solid #8a2be2;
            color: #8a2be2;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .back-button:hover {
            background: #8a2be2;
            color: white;
            transform: translateX(-5px);
        }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(to bottom, #f0f8ff, #e6e6fa);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { color: #6a0dad; text-align: center; }
    
    /* Upload Containers */
    .upload-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      max-width: 800px;
    }
    .tile-section {
      background: white;
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      width: 180px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: border-color 0.3s, box-shadow 0.3s;
      position: relative;
      cursor: pointer;
    }
    .tile-section:hover {
      border-color: #8a2be2;
      box-shadow: 0 4px 12px rgba(138,43,226,0.2);
    }
    .tile-section.has-image {
      border-color: #4caf50;
      box-shadow: 0 4px 12px rgba(76,175,80,0.3);
    }
    .tile-section h3 { 
      margin: 0 0 10px; 
      color: #6a0dad; 
      font-size: 1.1rem; 
    }
    .tile-section input[type="file"] {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }
    .scan-btn {
      margin: 10px 0;
      padding: 5px 10px;
      background: #8a2be2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .scan-btn:hover { background: #6a0dad; }
    .preview {
      width: 150px; /* Width is 1.5 times height */
      height: 100px; /* Height:Width = 1:1.5 ratio */
      border: 2px solid #ccc;
      border-radius: 8px;
      margin: 10px auto;
      object-fit: cover; /* Ensures image fits the wider rectangle without distortion */
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .preview-container {
      margin: 10px 0;
      min-height: 100px; /* Adjusted to match preview height */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clear-btn {
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 5px;
      display: none;
      font-size: 0.8rem;
    }
    .clear-btn:hover { background: #d32f2f; }
    .error { 
      color: red; 
      font-size: 0.9rem; 
      display: none; 
      margin-top: 5px;
    }
    .drag-text {
      font-size: 0.9rem;
      color: #888;
      margin: 10px 0;
      display: block;
    }
    
    /* Generate Button */
    #generateBtn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #8a2be2, #9370db);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 1.2rem;
      cursor: pointer;
      margin: 20px;
      box-shadow: 0 4px 10px rgba(138,43,226,0.3);
      transition: transform 0.2s;
    }
    #generateBtn:hover { transform: translateY(-2px); }
    #generateBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Error Display */
    #error { color: red; text-align: center; display: none; margin: 10px; }
    
    /* NEW: Preview Container Styles (now with 12 design sections) */
    #previewContainer {
      display: none;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow-x: auto; /* For horizontal scroll on small screens */
      position: relative; /* For positioning rotated row */
    }
    #previewContainer h2 {
      text-align: center;
      color: #6a0dad;
      margin-bottom: 20px;
    }
    .design-section {
      margin-bottom: 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }
    .design-section h3 {
      text-align: center;
      color: #6a0dad;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .design-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
      perspective: 1000px; /* 3D perspective for the table */
      transform-style: preserve-3d; /* Preserve 3D transforms for children */
    }
    .design-table th,
    .design-table td {
      border: 1px solid #ddd;
      padding: 0;
      width: 25%; /* Equal 4 columns */
      aspect-ratio: 1.5 / 1; /* 1.5:1 ratio (width:height = 1.5:1, wider cells) */
      height: auto; /* Let aspect-ratio control height */
      min-height: 80px; /* Minimum height based on ratio (e.g., for 120px width, 80px height) */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      vertical-align: top;
    }
    /* Fallback for older browsers: Padding hack for 1.5:1 ratio */
    .design-table td::before {
      content: '';
      display: block;
      padding-bottom: 66.67%; /* Height = width / 1.5 = 66.67% of width */
      float: left;
    }
    .design-table td > div {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .design-table th {
      aspect-ratio: 1 / 1; /* Square headers */
      background-color: #f0f8ff;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      font-size: 0.9rem;
      color: #6a0dad;
      height: 40px; /* Fixed for headers */
    }
    .cell-label {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      display: none; /* Optional: Show on hover or always */
      z-index: 1;
    }
    .design-table td:hover .cell-label {
      display: block; /* Show label on hover */
    }

    /* UPDATED: Style for 8th row (F tile flooring at 30 degrees towards viewer in 2D/3D perspective) - Applied to all designs */
    .design-table tr:nth-child(8) {
      transform: perspective(1000px) rotateX(30deg); /* 30-degree tilt towards viewer (rotateX for depth) */
      transform-origin: bottom center; /* Tilt from bottom center to simulate floor rising towards viewer */
      transform-style: preserve-3d; /* Preserve 3D for cells */
      position: relative;
      z-index: 1;
      margin-top: -40px; /* Increased overlap to touch row 7 properly (adjust as needed for seamless connection) */
    }
    .design-table tr:nth-child(8) td {
      aspect-ratio: 1.5 / 1; /* Maintain 1.5:1 ratio for flooring cells */
      min-height: 100px; /* Slightly taller for floor perspective and better overlap */
      background-size: cover !important;
      transform-style: preserve-3d; /* Ensure cells inherit 3D */
      border-top: none; /* Remove top border for seamless connection to row 7 */
    }
    .design-table tr:nth-child(7) td {
      border-bottom: 2px solid #ddd; /* Ensure bottom border on row 7 for definition */
    }
    .design-table tr:nth-child(8) .cell-label {
      transform: rotateX(-30deg); /* Counter-adjust labels for readability on tilted surface */
      bottom: 10px;
      background: rgba(0,0,0,0.8); /* Slightly more opaque for visibility on tilt */
    }
    
    /* Reset Button */
    #resetBtn {
      padding: 8px 16px;
      background: #8a2be2;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px auto;
      display: none;
    }
    #resetBtn:hover { background: #6a0dad; }
    
    /* NEW: Download Button */
    #downloadBtn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px auto;
      display: none;
      font-size: 1rem;
    }
    #downloadBtn:hover { background: linear-gradient(135deg, #45a049, #3d8b40); }
    #downloadBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* QR Scanner Modal */
    #qrScannerModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #qrScannerModal.show { display: flex; }
    .scanner-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    #qrVideo {
      width: 100%;
      max-width: 300px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    #closeScanner {
      margin-top: 10px;
      padding: 8px 16px;
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #closeScanner:hover { background: #d32f2f; }
    
    @media (max-width: 600px) {
      .upload-container { flex-direction: column; align-items: center; }
      .tile-section { width: 90%; }
      .preview { 
        width: 120px; 
        height: 80px; /* Maintain 1:1.5 ratio on mobile */
      }
      .preview-container { min-height: 80px; }
      .design-table td { 
        min-height: 60px; /* Adjusted minimum for mobile based on 1.5:1 ratio */
      }
      .design-section { margin-bottom: 20px; padding: 10px; }
      #previewContainer { padding: 10px; }
      .design-table tr:nth-child(8) { 
        transform: perspective(800px) rotateX(20deg); /* Reduced angle and perspective on mobile */
        margin-top: -30px; /* Adjusted overlap for mobile */
      }
      .design-table tr:nth-child(8) td { 
        min-height: 75px; 
      }
    }
  </style>
</head>
<body>
   <button class="back-button" onclick="history.back()">Back</button>

  <h1>Bathroom Tile [18x12]</h1>
  
  <div class="upload-container">
    <!-- L Tile -->
    <div class="tile-section" data-category="L">
      <h3>L Tile</h3>
      <input type="file" id="fileL" accept="image/*">
      <button class="scan-btn" id="scanL">Scan QR</button>
      <div class="preview-container">
        <img id="previewL" class="preview" alt="L Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearL">Clear</button>
      <p class="error" id="errorL">Please upload an image.</p>
    </div>
    
    <!-- HL Tile -->
    <div class="tile-section" data-category="HL">
      <h3>HL Tile</h3>
      <input type="file" id="fileHL" accept="image/*">
      <button class="scan-btn" id="scanHL">Scan QR</button>
      <div class="preview-container">
        <img id="previewHL" class="preview" alt="HL Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearHL">Clear</button>
      <p class="error" id="errorHL">Please upload an image.</p>
    </div>
    
    <!-- D Tile -->
    <div class="tile-section" data-category="D">
      <h3>D Tile</h3>
      <input type="file" id="fileD" accept="image/*">
      <button class="scan-btn" id="scanD">Scan QR</button>
      <div class="preview-container">
        <img id="previewD" class="preview" alt="D Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearD">Clear</button>
      <p class="error" id="errorD">Please upload an image.</p>
    </div>
    
    <!-- F Tile -->
    <div class="tile-section" data-category="F">
      <h3>F Tile</h3>
      <input type="file" id="fileF" accept="image/*">
      <button class="scan-btn" id="scanF">Scan QR</button>
      <div class="preview-container">
        <img id="previewF" class="preview" alt="F Preview">
        <span class="drag-text">Drag image here or click input</span>
      </div>
      <button class="clear-btn" id="clearF">Clear</button>
      <p class="error" id="errorF">Please upload an image.</p>
    </div>
  </div>
  
  <button id="generateBtn">GENERATE PREVIEW</button>
  
  <div id="error"></div>
  
  <!-- Preview Container (now with 12 design sections) -->
  <div id="previewContainer">
    <h2>Your Designs</h2>
    
    <!-- Design-1 Section -->
    <div class="design-section">
      <h3>Design-1</h3>
      <table class="design-table">
     
        <tbody id="design1Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-2 Section -->
    <div class="design-section">
      <h3>Design-2</h3>
      <table class="design-table">
   
        <tbody id="design2Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-3 Section -->
    <div class="design-section">
      <h3>Design-3</h3>
      <table class="design-table">
     
        <tbody id="design3Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-4 Section -->
    <div class="design-section">
      <h3>Design-4</h3>
      <table class="design-table">
        <tbody id="design4Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-5 Section -->
    <div class="design-section">
      <h3>Design-5</h3>
      <table class="design-table">
        <tbody id="design5Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-6 Section -->
    <div class="design-section">
      <h3>Design-6</h3>
      <table class="design-table">
        <tbody id="design6Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-7 Section -->
    <div class="design-section">
      <h3>Design-7</h3>
      <table class="design-table">
        <tbody id="design7Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-8 Section -->
    <div class="design-section">
      <h3>Design-8</h3>
      <table class="design-table">
        <tbody id="design8Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-9 Section -->
    <div class="design-section">
      <h3>Design-9</h3>
      <table class="design-table">
        <tbody id="design9Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-10 Section -->
    <div class="design-section">
      <h3>Design-10</h3>
      <table class="design-table">
        <tbody id="design10Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-11 Section -->
    <div class="design-section">
      <h3>Design-11</h3>
      <table class="design-table">
        <tbody id="design11Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Design-12 Section -->
    <div class="design-section">
      <h3>Design-12</h3>
      <table class="design-table">
        <tbody id="design12Body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>
  </div>

  <button id="resetBtn">Reset to Uploads</button>
  <button id="downloadBtn">Download PDF</button>

  <!-- QR Scanner Modal -->
  <div id="qrScannerModal">
    <div class="scanner-container">
      <h3>Scan QR Code</h3>
      <video id="qrVideo" autoplay></video>
      <p>Point your camera at a QR code to scan the image.</p>
      <button id="closeScanner">Close</button>
    </div>
  </div>

  <script>
    // DOM Elements
    const fileL = document.getElementById('fileL');
    const previewL = document.getElementById('previewL');
    const errorL = document.getElementById('errorL');
    const clearL = document.getElementById('clearL');
    const fileHL = document.getElementById('fileHL');
    const previewHL = document.getElementById('previewHL');
    const errorHL = document.getElementById('errorHL');
    const clearHL = document.getElementById('clearHL');
    const fileD = document.getElementById('fileD');
    const previewD = document.getElementById('previewD');
    const errorD = document.getElementById('errorD');
    const clearD = document.getElementById('clearD');
    const fileF = document.getElementById('fileF');
    const previewF = document.getElementById('previewF');
    const errorF = document.getElementById('errorF');
    const clearF = document.getElementById('clearF');
    const generateBtn = document.getElementById('generateBtn');
    const errorDiv = document.getElementById('error');
    const previewContainer = document.getElementById('previewContainer');
    const resetBtn = document.getElementById('resetBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // NEW: Array of all 12 design table bodies
    const designBodies = [
      document.getElementById('design1Body'),
      document.getElementById('design2Body'),
      document.getElementById('design3Body'),
      document.getElementById('design4Body'),
      document.getElementById('design5Body'),
      document.getElementById('design6Body'),
      document.getElementById('design7Body'),
      document.getElementById('design8Body'),
      document.getElementById('design9Body'),
      document.getElementById('design10Body'),
      document.getElementById('design11Body'),
      document.getElementById('design12Body')
    ];

    // Store uploaded image sources
    let uploadedImages = {};

    // Enhanced upload handler (previews show in containers with drag/drop)
    function handleFileUpload(input, preview, error, clearBtn, container, dragText) {
      input.addEventListener('change', (e) => {
        processFile(e.target.files[0], preview, error, clearBtn, container, dragText);
      });

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        container.style.borderColor = '#8a2be2';
      });
      container.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!container.classList.contains('has-image')) container.style.borderColor = '#ddd';
      });
      container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.style.borderColor = '#ddd';
        const file = e.dataTransfer.files[0];
        if (file) {
          input.files = e.dataTransfer.files;
          processFile(file, preview, error, clearBtn, container, dragText);
        }
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        preview.src = '';
        preview.style.display = 'none';
        dragText.style.display = 'block';
        error.style.display = 'none';
        container.classList.remove('has-image');
        clearBtn.style.display = 'none';
        // Remove from uploadedImages
        const category = container.dataset.category;
        delete uploadedImages[category];
      });
    }

    function processFile(file, preview, error, clearBtn, container, dragText) {
      if (file) {
        if (file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            dragText.style.display = 'none';
            error.style.display = 'none';
            container.classList.add('has-image');
            clearBtn.style.display = 'inline-block';
            // Store image source
            const category = container.dataset.category;
            uploadedImages[category] = e.target.result;
            console.log(`Image uploaded for ${category}.`);
          };
          reader.readAsDataURL(file);
        } else {
          error.textContent = 'Invalid image (must be JPG/PNG, <=5MB).';
          error.style.display = 'block';
          preview.style.display = 'none';
          dragText.style.display = 'block';
          container.classList.remove('has-image');
          clearBtn.style.display = 'none';
        }
      }
    }

    // Attach handlers
    const sections = [
      { input: fileL, preview: previewL, error: errorL, clear: clearL, container: document.querySelector('[data-category="L"]'), dragText: document.querySelector('[data-category="L"] .drag-text'), scan: document.getElementById('scanL') },
      { input: fileHL, preview: previewHL, error: errorHL, clear: clearHL, container: document.querySelector('[data-category="HL"]'), dragText: document.querySelector('[data-category="HL"] .drag-text'), scan: document.getElementById('scanHL') },
      { input: fileD, preview: previewD, error: errorD, clear: clearD, container: document.querySelector('[data-category="D"]'), dragText: document.querySelector('[data-category="D"] .drag-text'), scan: document.getElementById('scanD') },
      { input: fileF, preview: previewF, error: errorF, clear: clearF, container: document.querySelector('[data-category="F"]'), dragText: document.querySelector('[data-category="F"] .drag-text'), scan: document.getElementById('scanF') }
    ];

    sections.forEach(({ input, preview, error, clear, container, dragText, scan }) => {
      handleFileUpload(input, preview, error, clear, container, dragText);
      scan.addEventListener('click', () => {
        console.log('Scan button clicked for category:', container.dataset.category);
        currentScanCategory = container.dataset.category;
        qrScannerModal.classList.add('show');
        startScanner();
      });
    });

    // QR Scanner functionality
    let stream = null;
    let currentScanCategory = null;
    const qrScannerModal = document.getElementById('qrScannerModal');
    const qrVideo = document.getElementById('qrVideo');
    const closeScanner = document.getElementById('closeScanner');

    closeScanner.addEventListener('click', () => {
      qrScannerModal.classList.remove('show');
      stopScanner();
    });

    function startScanner() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then((mediaStream) => {
          stream = mediaStream;
          qrVideo.srcObject = stream;
          qrVideo.play();
          scanQRCode();
        })
        .catch((error) => {
          console.error('Error accessing camera:', error);
          alert('Unable to access camera. Please check permissions.');
        });
    }

    function stopScanner() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      qrVideo.srcObject = null;
    }

    function scanQRCode() {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const scan = () => {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
          context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            console.log('QR Code detected:', code.data);
            loadImageFromQR(code.data, currentScanCategory);
            stopScanner();
            qrScannerModal.classList.remove('show');
          }
        }
        requestAnimationFrame(scan);
      };
      scan();
    }

    async function loadImageFromQR(qrData, category) {
      console.log('QR Code data received:', qrData);
      try {
        const img = new Image();
        img.onload = () => {
          const section = sections.find(s => s.container.dataset.category === category);
          if (section) {
            section.preview.src = qrData;
            section.preview.style.display = 'block';
            section.dragText.style.display = 'none';
            section.error.style.display = 'none';
            section.container.classList.add('has-image');
            section.clear.style.display = 'inline-block';
            uploadedImages[category] = qrData;
            console.log('Image loaded successfully from QR code.');
          }
        };
        img.onerror = () => {
          console.error('Failed to load image from QR data:', qrData);
          alert('The QR code does not contain a valid image URL. Please scan a QR code with a direct image link.');
        };
        img.src = qrData;
      } catch (error) {
        console.error('Error processing QR data:', error);
        alert('Failed to process the QR code data.');
      }
    }

    // Load saved images from localStorage on page load
    const savedImages = localStorage.getItem('uploadedImages');
    if (savedImages) {
      try {
        const parsedImages = JSON.parse(savedImages);
        uploadedImages = parsedImages;
        // Restore previews if images exist
        Object.keys(uploadedImages).forEach(category => {
          const preview = document.getElementById(`preview${category}`);
          const container = document.querySelector(`[data-category="${category}"]`);
          const dragText = container.querySelector('.drag-text');
          const error = document.getElementById(`error${category}`);
          const clear = document.getElementById(`clear${category}`);
          if (preview && uploadedImages[category]) {
            preview.src = uploadedImages[category];
            preview.style.display = 'block';
            dragText.style.display = 'none';
            error.style.display = 'none';
            container.classList.add('has-image');
            clear.style.display = 'inline-block';
          }
        });
        console.log('Loaded saved images from localStorage.');
      } catch (e) {
        console.warn('Invalid saved images in localStorage:', e);
      }
    }

    // Generate button: Validates uploads, shows preview container with 12 designs
    generateBtn.addEventListener('click', () => {
      let valid = true;
      const required = ['L', 'HL', 'D', 'F']; // Still require all
      required.forEach(category => {
        if (!uploadedImages[category]) {
          const errorElem = document.getElementById(`error${category}`);
          errorElem.textContent = `Please upload ${category} image.`;
          errorElem.style.display = 'block';
          valid = false;
        }
      });

      if (!valid) {
        errorDiv.textContent = 'Please upload all four images before generating.';
        errorDiv.style.display = 'block';
        return;
      }

      errorDiv.style.display = 'none';
      generateBtn.style.display = 'none';
      resetBtn.style.display = 'block';
      downloadBtn.style.display = 'block'; // Show download button

      // Show preview container and populate all 12 designs
      previewContainer.style.display = 'block';
      populateAllDesigns();

      // Save to localStorage
      localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));

      console.log('All 12 designs generated with uploaded images.');
    });

    // NEW: Design-specific cell positions (row, col) for L, HL, D images (F always in row 8)
    const designConfigs = [
      // Design-1
      {
        L: [[1,1],[1,2],[1,3],[1,4],[2,1],[2,2],[2,3],[2,4],[3,1],[3,2],[3,3],[3,4]],
        HL: [[4,1],[4,2],[4,3],[4,4]],
        D: [[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]]
      },
      // Design-2
      {
        L: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[3,4],[4,4],[2,4],[5,1],[5,2],[5,3],[5,4]], // Removed duplicate (2,1)
        HL: [[3,1],[3,2],[3,3],[2,2],[4,1],[4,2],[4,3],[2,3]],
        D: [[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]]
      },
      // Design-3
      {
        L: [[2,1],[2,2],[2,3],[2,4],[4,1],[4,2],[4,3],[4,4]],
        HL: [[3,1],[3,2],[3,3],[3,4]],
        D: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]]
      },
      // Design-4
      {
        L: [], // Empty
        HL: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]],
        D: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4],[2,4],[3,4],[4,4]] // Removed duplicates
      },
      // Design-5
      {
        L: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4],[2,4],[3,4],[4,4]],
        HL: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]],
        D: [] // Empty
      },
      // Design-6
      {
        L: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]],
        HL: [], // Empty
        D: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4],[2,4],[3,4],[4,4]]
      },
      // Design-7
      {
        L: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4],[2,4],[3,4],[4,4]],
        HL: [], // Empty
        D: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]]
      },
      // Design-8
      {
        L: [[4,1],[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[2,1],[3,1],[5,2],[5,3],[5,1],[2,4],[3,4],[4,4],[5,4]], // Cleaned duplicates
        HL: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]],
        D: [[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]] // Empty
      },
      // Design-9
      {
        L: [[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]], // Empty
        HL: [[2,2],[2,3],[3,2],[3,3],[4,2],[4,3]],
        D: [[4,1],[1,1],[1,2],[5,1],[1,3],[5,2],[5,3],[5,4],[1,4],[2,1],[3,1],[2,1],[3,1],[5,2],[5,3],[5,1],[2,4],[3,4],[4,4],[5,4]] // Cleaned
      },
      // Design-10
      {
        L: [[6,1],[6,2],[6,3],[6,4],[4,1],[4,2],[4,3],[4,4],[2,1],[2,2],[2,3],[2,4]],
        HL: [], // Empty
        D: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[3,1],[3,2],[3,3],[3,4],[5,1],[5,2],[5,3],[5,4],[7,1],[7,2],[7,3],[7,4]] // Removed duplicate (3,1)
      },
      // Design-11
      {
        L: [[1,1],[1,2],[1,3],[1,4],[2,1],[3,1],[4,1],[2,2],[2,3],[2,4],[3,1],[3,2],[3,3],[3,4],[4,1],[4,2],[4,3],[4,4]],
        HL: [], // Empty
        D: [[5,1],[5,2],[5,3],[5,4],[6,1],[6,2],[6,3],[6,4],[7,1],[7,2],[7,3],[7,4]]
      },
      // Design-12
      {
        L: [[2,1],[1,4],[1,2],[2,3],[3,2],[3,4],[4,1],[4,3],[5,2],[5,4],[6,1],[6,3],[7,2],[7,4]], // Cleaned
        HL: [], // Empty
        D: [[1,1],[3,1],[2,2],[2,4],[1,3],[3,3],[4,2],[4,4],[5,1],[5,3],[6,2],[6,4],[7,1],[7,3]]
      }
    ];

    // NEW: Function to populate all 12 designs with custom cell assignments
    function populateAllDesigns() {
      designBodies.forEach((body, designIndex) => {
        body.innerHTML = ''; // Clear previous for this design

        const config = designConfigs[designIndex];
        const lPositions = new Set(config.L.map(pos => `${pos[0]},${pos[1]}`));
        const hlPositions = new Set(config.HL.map(pos => `${pos[0]},${pos[1]}`));
        const dPositions = new Set(config.D.map(pos => `${pos[0]},${pos[1]}`));

        // Create 8 rows for this design
        for (let row = 1; row <= 8; row++) {
          const tr = document.createElement('tr');

          for (let col = 1; col <= 4; col++) {
            const td = document.createElement('td');
            const posKey = `${row},${col}`;
            let imageSrc = '';
            let labelText = `Design-${designIndex + 1} (${row},${col})`;

            // Assign image based on position
            if (row === 8) {
              // F always in row 8 (flooring)
              imageSrc = uploadedImages.F;
              labelText += ' F Tile';
            } else if (lPositions.has(posKey)) {
              imageSrc = uploadedImages.L;
              labelText += ' L Tile';
            } else if (hlPositions.has(posKey)) {
              imageSrc = uploadedImages.HL;
              labelText += ' HL Tile';
            } else if (dPositions.has(posKey)) {
              imageSrc = uploadedImages.D;
              labelText += ' D Tile';
            } else {
              // Default for unassigned cells
              td.style.backgroundColor = '#f0f0f0';
              labelText += ' Default';
            }

            td.id = `design${designIndex + 1}-cell-r${row}c${col}`; // Unique ID
            td.style.backgroundImage = imageSrc ? `url(${imageSrc})` : 'none';
            td.innerHTML = `<div class="cell-label">${labelText}</div>`;
            tr.appendChild(td);
          }

          body.appendChild(tr);
        }
      });
    }

    // NEW: Download PDF function using jsPDF and html2canvas
    downloadBtn.addEventListener('click', async () => {
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Generating PDF...';
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, mm, A4 size
        let yPosition = 10; // Starting Y position
        const pageHeight = pdf.internal.pageSize.height - 20; // Leave margins

        // Add title
        pdf.setFontSize(16);
        pdf.text('Bathroom Tile Designs PDF', 105, yPosition, { align: 'center' });
        yPosition += 15;

        // Loop through each design section and add to PDF
        const designSections = document.querySelectorAll('.design-section');
        for (let i = 0; i < designSections.length; i++) {
          const section = designSections[i];
          const canvas = await html2canvas(section, {
            scale: 2, // Higher scale for better quality
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          });

          const imgData = canvas.toDataURL('image/png');
          const imgWidth = 190; // Width in mm (A4 is ~210mm wide)
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          // Check if it fits on current page
          if (yPosition + imgHeight > pageHeight) {
            pdf.addPage();
            yPosition = 10;
          }

          pdf.addImage(imgData, 'PNG', 10, yPosition, imgWidth, imgHeight);
          yPosition += imgHeight + 10; // Space between sections

          // Add page break if needed for next section
          if (i < designSections.length - 1 && yPosition > pageHeight - 50) {
            pdf.addPage();
            yPosition = 10;
          }
        }

        // Save the PDF
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        pdf.save(`Bathroom_Tile_Designs_${timestamp}.pdf`);

        console.log('PDF downloaded successfully.');
      } catch (error) {
        console.error('Error generating PDF:', error);
        errorDiv.textContent = 'Error generating PDF. Please try again.';
        errorDiv.style.display = 'block';
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'Download PDF';
      }
    });

    // Reset button listener
    resetBtn.addEventListener('click', () => {
      // Reset everything
      uploadedImages = {};
      sections.forEach(({ input, preview, error, clear, container, dragText }) => {
        input.value = '';
        preview.src = '';
        preview.style.display = 'none';
        dragText.style.display = 'block';
        error.style.display = 'none';
        container.classList.remove('has-image');
        clear.style.display = 'none';
      });
      previewContainer.style.display = 'none';
      // Clear all design bodies
      designBodies.forEach(body => body.innerHTML = '');
      generateBtn.style.display = 'block';
      resetBtn.style.display = 'none';
      downloadBtn.style.display = 'none'; // Hide download button
      errorDiv.style.display = 'none';
      // Clear localStorage
      localStorage.removeItem('uploadedImages');
      console.log('Reset to upload state.');
    });

    // Final script load confirmation
    console.log('Bathroom Tile Uploader & Preview Generator loaded completely.');
  </script>
</body>
</html>
